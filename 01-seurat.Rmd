
# Visualizing Seurat objects


```{r pbmc-create}
library(Seurat)
dir = "data/filtered_gene_bc_matrices/hg19"

pbmc.data <- Read10X(data.dir = dir)
pbmc <- CreateSeuratObject(counts = pbmc.data, project = "pbmc3k", 
                          min.cells=3, min.features=200)
pbmc
```

```{r pbmc-qc}
pbmc[["percent.mt"]] <- PercentageFeatureSet(pbmc, pattern = "^MT-")
pbmc <- subset(pbmc,
  subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5
)
```

```{r pbmc-normalize}
pbmc <- NormalizeData(pbmc, normalization.method = "LogNormalize",
                      scale.factor = 10000)
pbmc <- ScaleData(pbmc)
```

```{r pbmc-dimension-reduction}
pbmc <- FindVariableFeatures(pbmc, selection.method = "vst",
                             nfeatures = 2000)
pbmc <- RunPCA(pbmc, features = VariableFeatures(object = pbmc))
pbmc <- RunUMAP(pbmc, dims = 1:10)
```

```{r pbmc-clusters}
pbmc <- FindNeighbors(pbmc, dims = 1:10)
pbmc <- FindClusters(pbmc, resolution = 0.5)

## Assigning cell type identity to clusters
cluster.ids <- c("Naive CD4 T", "CD14+ Mono", "Memory CD4 T", 
            "B", "CD8 T", "FCGR3A+ Mono", "NK", "DC", "Platelet")
names(cluster.ids) <- levels(pbmc)
pbmc <- RenameIdents(pbmc, cluster.ids)
```

```{r pbmc-markers}
pbmc.markers <- FindAllMarkers(pbmc, only.pos = TRUE)
```


## Dimensional reduction plot

```{r dimplot, fig.width=9, fig.height=6}
# DimPlot(pbmc, reduction = "umap",
#        label = TRUE, pt.size = 0.5) 

library(ggplot2)
library(ggsc)

sc_dim(pbmc) + sc_dim_geom_label()
# using vector point layer when geom = geom_bgpoint
sc_dim(pbmc, geom = geom_bgpoint, pointsize=1) + sc_dim_geom_label()

p <- sc_dim(pbmc) + 
    sc_dim_geom_label(geom = shadowtext::geom_shadowtext, 
            color='black', bg.color='white')
p
f <- sc_dim(pbmc, bg_colour = 'black') +
    sc_dim_geom_label(geom = shadowtext::geom_shadowtext, 
    color = 'black', bg.color='white')
f
f2 <- sc_dim(pbmc, 
             mapping = aes(bg_colour = ident), 
             geom = geom_bgpoint, 
             pointsize=1,
	     gap_line_width=.2
      ) +
      sc_dim_geom_label(geom = shadowtext::geom_shadowtext,
      color = 'black', bg.color='white')
f2
```


The number of cells in each clusters can be easily Visualized using `sc_dim_count()`. The colors of the bar plot is consistent with the dimensional reduction plot.

```{r dimplot-cnt, fig.width=13, fig.height=6}
p2 <- sc_dim_count(p)

library(aplot)
plot_list(p, p2, widths=c(1, .5))
```


```{r comparecluster-seurat-marker}
library(dplyr)

top20 <- pbmc.markers |>
    dplyr::group_by(cluster) |>
    dplyr::filter(avg_log2FC > 1) |>
    dplyr::slice_head(n = 20) |>
    dplyr::ungroup()

library(clusterProfiler)
library(enrichplot)

gg <- bitr(top20$gene, 'SYMBOL', 'ENTREZID', 'org.Hs.eg.db') 
top20 <- merge(top20, gg, by.x='gene', by.y = 'SYMBOL')

kk <- compareCluster(ENTREZID~cluster, data = top20, fun=enrichKEGG)
```

```{r dimplot-cp-dotplot, fig.width=8, fig.height=13}
g <- dotplot(kk, label_format=100) + 
  aes(x=sub("\n.*", "", Cluster)) + 
  xlab("Cell Clusters") +
  ggtitle(NULL) +
  theme(axis.text.x = element_text(angle=30, hjust=1))

p3 <- p2 + coord_cartesian() + 
  ggfun::theme_noxaxis() + 
  xlab(NULL) 

insert_top(g, p3, height=.2)
```


## Visualize 'features' on a dimensional reduction plot

```{r feature-plot}
features = c("MS4A1", "GNLY", "CD3E", 
            "CD14", "FCER1A", "FCGR3A", 
            "LYZ", "PPBP", "CD8A")

# FeaturePlot(pbmc,'CD4')
sc_feature(pbmc, 'CD4')
sc_feature(pbmc, "CD4", bg_colour = 'black', geom = geom_bgpoint)
sc_feature(pbmc, "CD4", mapping = aes(bg_colour = ident))
```


```{r feature-plot-multi}
sc_feature(pbmc, features)

sc_feature(pbmc, features, mapping = aes(bg_color = ident), geom = geom_bgpoint, pointsize=.5)
```


Here is the real 'features' on dimensional plot


```{r dim-feature}
sc_dim(pbmc) + 
   sc_dim_geom_feature(pbmc, 'CD4', color='black')

sc_dim(pbmc, alpha=.3) + 
    ggnewscale::new_scale_color() + 
    sc_dim_geom_feature(pbmc, features, mapping=aes(color=features)) +
    scale_color_viridis_d()

sc_dim(pbmc, geom = geom_bgpoint) +
    sc_dim_geom_feature(pbmc, 'CD4', bg_colour = 'grey')

sc_dim(pbmc, alpha=.3) +
    ggnewscale::new_scale_color() +
    sc_dim_geom_feature(pbmc, features, mapping=aes(color=features)) +
    scale_color_viridis_d()

sc_feature(pbmc,
           mapping = aes(bg_colour = RNA_snn_res.0.5),
           features = features,
           reduction = 'umap',
           geom = geom_bgpoint,
           pointsize = 1
  ) +
  ggnewscale::new_scale_color() +
  sc_dim_geom_ellipse(
     mapping = aes(group = RNA_snn_res.0.5, colour=RNA_snn_res.0.5),
  ) +
  sc_dim_geom_label(
     geom = shadowtext::geom_shadowtext,
     mapping = aes(label = RNA_snn_res.0.5, colour = RNA_snn_res.0.5),
     bg.color = 'white',
     size = 5
  )
```

```{r dim-feature-density, fig.width=14, fig.height=6}
p1 <- sc_feature(pbmc, features='CD3E', density = FALSE) + scale_color_viridis_c()
p2 <- sc_feature(pbmc, features='CD3E', density = TRUE) + scale_color_viridis_c()

p1 | p2

f1 <- sc_feature(pbmc, features = 'CD3E', 
                 mapping = aes(bg_colour = ident), 
                 geom = geom_bgpoint, 
                 density = FALSE, 
                 bg_line_width = .4,
                 gap_line_width = .2,
                 size = .5) + 
                 scale_color_viridis_c()
f2 <- sc_feature(pbmc, features = 'CD3E', 
                 mapping = aes(bg_colour = ident), 
                 geom = geom_bgpoint, 
                 density = TRUE,
                 bg_line_width = .4,
                 gap_line_width = .22,
                 size = .8) + 
		 scale_color_viridis_c()

f1 | f2
```

## Visualize ellipse on a dimensional reduction plot

```{r dim-ellipse}
sc_dim(pbmc) +
  sc_dim_geom_ellipse(level=0.95)
```

## Visualize selected clusters 

```{r dim-sub}
selected <- c("Naive CD4 T", "NK")
sc_dim(pbmc) + 
  sc_dim_sub(subset=selected)
```

```{r dim-sub-label}
sc_dim(pbmc, color='grey', geom = geom_bgpoint, pointsize=1) + 
  sc_dim_geom_sub(subset=selected, mapping = aes(bg_colour = ident)) + 
    sc_dim_geom_label(geom = shadowtext::geom_shadowtext, 
          mapping = aes(subset = ident %in% selected),
            color='black', bg.color='white')
```


## Dot plot for selected features

```{r sc-dot}
features = c("MS4A1", "GNLY", "CD3E", 
            "CD14", "FCER1A", "FCGR3A", 
            "LYZ", "PPBP", "CD8A")
# DotPlot(pbmc, features = features,
#        group.by = 'seurat_clusters')

sc_dot(pbmc, features=features)
```        



## Violin plot of gene expression

```{r sc-violin}
# VlnPlot(pbmc,'CD4')

sc_violin(pbmc, 'CD4') + guides(x = guide_axis(angle = -45))

## allows applying an user-defined function to transform/filter the data
sc_violin(pbmc, 'CD4', .fun=function(d) dplyr::filter(d, value > 0)) +
  ggforce::geom_sina(size=.1) +
  guides(x = guide_axis(angle = -45))
```

```{r sc-violin-multi, fig.height=9}
#VlnPlot(pbmc, features)
sc_violin(pbmc, features) + 
  theme(axis.text.x = element_text(angle=45, hjust=1))
```



## Spatial features

```{r sc_spatial-data}
library(SeuratData)
if (!requireNamespace("SVP", quietly=TRUE)){
    remotes::install_github("YuLab-SMU/SVP")
}
# InstallData("stxBrain")
brain <- LoadData("stxBrain", type = "anterior1")
# Normalization 
brain <- SCTransform(brain, assay = "Spatial", verbose = FALSE)
```

```{r sc_spatial, fig.width=10, fig.height=10}
## SpatialFeaturePlot(brain, features = c("Hpca", "Ttr"))
f1 <- sc_spatial(brain, features = c("Hpca", "Ttr"), image.mirror.axis = 'v', geom = geom_bgpoint, pointsize=1.5)
f2 <- sc_spatial(brain, features=c("Hpca", "Ttr"), image.mirror.axis='v', density=TRUE, geom=geom_bgpoint, pointsize=1.5)
plot_list(f1, f2, ncol=1)
```

```{r sc_spatail-hight_annot, fig.width = 15, fig.height = 10}
{library(SingleCellExperiment)
library(SpatialExperiment)} |> suppressPackageStartupMessages()
spe.brain <- brain |> as.SingleCellExperiment()
spe.brain <- as(spe.brain, "SpatialExperiment")
spatialCoords(spe.brain) <- GetTissueCoordinates(brain)[,seq(2)] |> as.matrix()
spe.brain
library(SVP)
res.lisa1 <- runLISA(spe.brain, features = c("Hpca", "Ttr"), assay.type = 'logcounts', weight.method='knn', k=20)
da.lisa1 <- res.lisa1 |> lapply(function(x)x |> tibble::rownames_to_column(var='.BarcodeID')) |> dplyr::bind_rows(.id='features')
head(da.lisa1)
# The features and .BarcodeID must be provided
# which be the same to the .BarcodeID and features of 
# f1$data
f1 + sc_geom_annot(
        data=da.lisa1, 
        mapping = aes(bg_color=cluster.test, subset=cluster.test=='High'), 
        pointsize =1.5,
        bg_line_width = .3, 
        gap_line_width=.3,
      ) +
      scale_bg_colour_manual(values = 'black')
f2 + sc_geom_annot(
        data = da.lisa1,
	mapping = aes(bg_colour = cluster.test, subset = cluster.test == 'High'),
	pointsize = 1.5,
        bg_line_width = .3,
	gap_line_width = .3) +
	scale_bg_colour_manual(values = 'black')
```


```{r sc_spatial-density, fig.width=15, fig.height=10}
f3 <- sc_spatial(brain, features=c("Hpca", "Ttr"), image.mirror.axis='v', 
    density=TRUE, joint=TRUE)
f4 <- sc_spatial(brain, features=c("Hpca", "Ttr"), image.mirror.axis='v', 
    density=TRUE, joint=TRUE, common.legend=FALSE)
plot_list(f3, f4, ncol=1)
```

```{r sc_spatail-hight_annot_image, fig.width = 15, fig.height = 10}

```

```{r sc_spatial-pie}
genes <- rownames(brain) |> sample(10)
sc_spatial(brain, features=genes, plot.pie=TRUE, 
        pie.radius.scale=.35, image.plot=FALSE,
        color = NA
	)
```



